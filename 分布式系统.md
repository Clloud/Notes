# 一、分布式系统

分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。

## 1. CAP定理

分布式系统不可能同时满足一致性、可用性和分区容忍性，最多只能同时满足其中两项。

### 一致性 (Consistency)

一致性指的是数据在多个副之间能否保持一致的特性，在一致性的条件下，系统在执行数据更新操作之后能够从一致性状态转移到另一个一致性状态。

### 可用性 (Availability)

可用性指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在**有限的时间内返回结果**。

### 分区容忍性 (Partition Tolerance)

网络分区指分布式系统中的节点被划分为多个区域，每个区域内部可以通信，但是区域之间无法通信。

在分区容忍性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。

### 权衡

在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的。因此，CAP 理论实际上是要在可用性和一致性之间做权衡。

可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，

- 为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性
- 为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致

## 2. 一致性级别

### 强一致性

要求系统在某节点写入数据后，从其他节点能读出一致的数据，实现起来对系统的性能影响较大。

### 弱一致性

系统在成功写入数据后，不承诺可以立即读到写入的值，也不承诺多久之后数据能够达到一致，但会尽可能保证到某个时间后，数据能够达到一致性状态。弱一致性可以分为：

- 会话一致性：只保证对于写入的值，在同一个客户端会话中可以读到一致的值，但其他会话不能保证
- 用户一致性：只保证对于写入的值，在同一个用户中可以读到一致的值，但其他用户不能保证

#### 最终一致性

最终一致性是弱一致性的特例，是一种非常重要的一致性模型，即系统会保证在一定时间内，能够达到一个数据一致的状态。

## 3. 分布式事务

### 概念

[深入理解分布式事务](https://juejin.im/entry/577c6f220a2b5800573492be)

事务的操作位于不同的节点上，需要保证事务的 ACID 特性。

分布式事务可以保证不同数据库的数据一致性。一个分布式事务可以看作是由多个分布式的操作序列组成的，这些子事务分布在不同的节点上，分布式事务需要保证这些子事务要么全部成功，要么全部失败。

例如，买家在电商平台下单，需要扣库存和更新订单数据，如果库存数据库和订单数据库不在同一个节点上，就涉及分布式事务。

### 实现方式

分布式事务是对多个数据库的事务进行统一控制，按照控制力度可以分为：

- 不控制：保证可用性，但不保证数据一致性
- 部分控制：采用两阶段提交策略，兼顾可用性和一致性
- 完全控制：牺牲可用性，保证数据的强一致性

#### 两阶段提交

两阶段提交 (Two-phase Commit) ，通过引入协调者 (Coordinator) 来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

##### 运行过程

- 准备阶段

协调者询问参与者事务是否执行成功，参与者发回事务执行结果。询问可以看成一种投票，需要参与者都同意才能执行。

<img src=".\images\Gyf94hANSKqbLN1X.png" alt="img" style="zoom:60%;" />

- 提交阶段

如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务；否则，协调者发送通知让参与者回滚事务。

需要注意的是，在准备阶段，参与者执行了事务，但是还未提交。只有在提交阶段接收到协调者发来的通知后，才进行提交或者回滚。

<img src=".\images\mztT5lHvH3tenC64.png" alt="img" style="zoom:60%;" />


##### 存在的问题

- 同步阻塞
所有事务参与者在等待其它参与者响应的时候都处于同步阻塞等待状态，无法进行其它操作。

- 单点问题
协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响。特别是在提交阶段发生故障，所有参与者会一直同步阻塞等待，无法完成其它操作。

- 数据不一致
在提交阶段，如果协调者只发送了部分 Commit 消息，此时网络发生异常，那么只有部分参与者接收到 Commit 消息，也就是说只有部分参与者提交了事务，使得系统数据不一致。

- 太过保守
任意一个节点失败就会导致整个事务失败，没有完善的容错机制。

# ZooKeeper

zookeeper 是一个分布式的、开源的分布式应用程序协调服务，是 google chubby 的开源实现，是 hadoop 和 hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。

# RPC

# Dubbo
